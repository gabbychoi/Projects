/****************************************************************************************************************
SP 명  : PROC_TB_DW_FACT_SCM_SUPPLY_SIMULATION_RESULT
SP Owner    : scm
SP 제목  : RunworkInput Result Insert
최초작성자 : 최은수
최초작성일 : 2024.09.11
SP 실행 예 : EXEC scm.PROC_TB_DW_FACT_SCM_SUPPLY_SIMULATION_RESULT
SP 설명  : RunworkInput Result Insert 임시 데이터 처리 프로시저
변경이력  : 변경일/변경자/요청자/요청일/내용 
******************************************************************************************************************/
CREATE   PROC [scm].[PROC_TB_DW_FACT_SCM_SUPPLY_SIMULATION_RESULT]
AS
BEGIN
DECLARE @SP_START_EXEC  DATETIME = GETDATE() -- SP 실행시작시간
 DECLARE @INSERT_CNT INT = 0   -- INSERT 건수
 DECLARE @UPDATE_CNT INT = 0   -- UPDATE 건수
 DECLARE @DELETE_CNT INT = 0   -- DELETE 건수
 DECLARE @TABLE_NM VARCHAR(50) = 'TB_DW_FACT_SCM_SUPPLY_SIMULATION_RESULT' -- TARGET TABLE NAME
 BEGIN TRY
  DELETE FROM scm.TB_DW_FACT_SCM_SUPPLY_SIMULATION_RESULT
  WHERE ERSDA>=(SELECT MIN(ERSDA) FROM ODS_YG1.ods_scm.TB_ODS_ZDWT005_COOIS_CHANGE)
  SET @DELETE_CNT = @@ROWCOUNT
  
  INSERT INTO SCM.TB_DW_FACT_SCM_SUPPLY_SIMULATION_RESULT
  SELECT  A.*,
    ISNULL(B.ARBPL,'대기') AS WORK_CENTER,
    KTSCH AS WORK_CENTER_KEY,
    B.KTEXT,
    CASE WHEN B.VORNR='REL' THEN '배정' 
    WHEN B.VORNR IS NULL THEN '미배정'
    ELSE B.VORNR END AS VORNR,
    C.DISPO AS [MRP_CONTROLLER],
    C.MATKL AS [MATKL],
    CASE WHEN B.SSELD>0 THEN DATEFROMPARTS(B.SSELD/10000, (B.SSELD/100)%100, B.SSELD%100) ELSE NULL END as SSELD,
    CASE WHEN B.GLTRP>0 THEN DATEFROMPARTS(B.GLTRP/10000, (B.GLTRP/100)%100, B.GLTRP%100) ELSE NULL END as  Actual_Finish_Date,
    CASE WHEN B.GLTRP<A.ERSDA THEN '완료' ELSE VORNR END as [완료여부],
    C.MAKTX,
    @SP_START_EXEC
  FROM (SELECT *
  FROM [scm].[VW_SCM_MatchOrderProd]
  WHERE ERSDA>=(SELECT MIN(ERSDA) FROM ODS_YG1.ods_scm.TB_ODS_ZDWT005_COOIS_CHANGE)
  ) A LEFT OUTER JOIN scm.TB_DW_FACT_ZDWT006_Z25PP031 B
  ON A.ERSDA=B.ERSDA AND A.MANDT=B.MANDT AND A.[생산_Order_Key]=B.AUFNR
  LEFT OUTER JOIN scm.TB_DW_DIM_ZDWT005_COOIS C
  ON A.[생산_Order_Key]=C.AUFNR AND A.MANDT=C.MANDT AND A.ERSDA=C.ERSDA
  WHERE B.DISPO NOT LIKE 'CO%' --코팅작번 제외 
   SET @INSERT_CNT= @@ROWCOUNT
   
   
  
  INSERT INTO DW_YG1.DBO.TB_ETL_LOG
     (DB_NM   , SP_NM       , TABLE_NM  , START_DATE  , END_DATE  
     , INSERT_CNT , DELETE_CNT , UPDATE_CNT , SUCCEESS_YN , ERR_MSG   , ERR_NUM , ERR_LINE)
   VALUES (DB_NAME()  , OBJECT_NAME(@@PROCID)   , @TABLE_NM  , @SP_START_EXEC , GETDATE()
     , @INSERT_CNT , @DELETE_CNT , @UPDATE_CNT , 'Y'   , NULL    , NULL  , NULL)
   
   RETURN
 END TRY
 BEGIN CATCH
  INSERT INTO DW_YG1.DBO.TB_ETL_LOG
     (DB_NM   , SP_NM       , TABLE_NM  , START_DATE  , END_DATE  
     , INSERT_CNT , DELETE_CNT , UPDATE_CNT , SUCCEESS_YN , ERR_MSG   , ERR_NUM  , ERR_LINE)
   VALUES (DB_NAME()  , OBJECT_NAME(@@PROCID)   , @TABLE_NM  , @SP_START_EXEC , GETDATE()
     , @INSERT_CNT , @DELETE_CNT , @UPDATE_CNT , 'N'   , ERROR_MESSAGE() , ERROR_NUMBER(), ERROR_LINE())
  
  RETURN
 END CATCH
 
END